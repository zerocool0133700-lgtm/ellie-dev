# Journal — February 20, 2026

## Session ID: `c6196b7c-4a8e-46d4-9481-c82eb0750777`

## Security Hardening & Production Mode Migration

This session continued from a prior conversation focused on ELLIE-86 (Outlook email integration, completed earlier) and shifted to security hardening and infrastructure stabilization for the Nuxt dashboard.

### Dashboard Production Mode

Discovered that Nuxt dev mode (Vite) is incompatible with Cloudflare Access tunnel serving. Vite injects `@fs` paths, `crossorigin` attributes, and HMR websocket connections that break when proxied through CF Access. After extensive debugging (CSS MIME type errors, failed dynamic imports), the solution was switching to production mode:

- `bun run build` generates bundled static files in `.output/`
- `bun .output/server/index.mjs` serves the production build
- All `@fs` paths and `crossorigin` issues eliminated

**Tradeoff:** Code changes now require `bun run build` + service restart (no more HMR).

### Localhost Binding Fix

The `devServer.host: '127.0.0.1'` setting in `nuxt.config.ts` only applies to `nuxt dev`. In production mode, Nitro defaults to `0.0.0.0` (all interfaces), re-exposing port 3000 to the network.

**Fix:** Added `HOST=127.0.0.1` to `/home/ellie/ellie-home/.env`. Verified with `ss -tlnp` showing `127.0.0.1:3000` instead of `*:3000`.

### Systemd Service

Created `/etc/systemd/system/ellie-dashboard.service` so the dashboard survives reboots:

- Runs as user `ellie`
- Working directory: `/home/ellie/ellie-home`
- Reads env from `/home/ellie/ellie-home/.env`
- Auto-restarts on failure
- Enabled at boot via `systemctl enable`

Management: `sudo systemctl restart ellie-dashboard`, `journalctl -u ellie-dashboard -f`

### Tunnel Guard Cleanup

Removed debug logging (`[guard] PASS ${path} via session`) and the unused `path` variable from `server/middleware/tunnel-guard.ts`. Rebuilt and restarted production server.

### Relay Fix — Async/Await Syntax Error

Relay was down due to a syntax error at line 3319 of `src/relay.ts`. A memory dashboard handler used `await readFile()` directly inside the non-async HTTP server callback (`createServer((req, res) => { ... })`).

**Fix:** Wrapped the handler body in an async IIFE `(async () => { ... })()` to match the pattern used by other handlers in the same file (e.g., rollup GET endpoints).

This code was added by one of Ellie's agent sessions but never committed or tested — the relay hadn't been restarted since it was added, so the error went undetected.

### Git Commit

Committed and pushed all dashboard changes as `b2f0f91` on `main` (58 files, 3810 insertions). Includes:
- Full Nuxt dashboard buildout (pages, components, API endpoints, composables)
- Supabase/Drizzle integration
- Cloudflare Access JWT validation in tunnel-guard middleware
- Security hardening (localhost binding, sameSite cookie fix)

### Discussion: QA Agent & Agile Pipeline

Brainstormed the next evolution of Ellie's development workflow — a full agile pipeline with specialized agents:

1. **BA Agent** — works with Dave to spec requirements
2. **Plane ticket** created as handoff artifact
3. **Architect Agent** — picks up ticket, designs approach
4. **Dev Agent** — implements the design
5. **QA Agent** — tests in isolated working directory (own git clone, can build/run/break things without affecting production)
6. **Critic Agent** — end-of-sprint review for architecture drift, tech debt, security

**Key insight:** QA agent should be built first — it addresses the most immediate gap (agent-written code shipping with bugs like the async/await error). Needs its own working directory to pull code, install deps, build, and run tests independently.

### Files Modified

| File | Change |
|------|--------|
| `ellie-home/server/middleware/tunnel-guard.ts` | Removed debug logging, unused `path` variable |
| `ellie-home/nuxt.config.ts` | `devServer.host` → `127.0.0.1` |
| `ellie-home/.env` | Added `HOST=127.0.0.1` |
| `ellie-dev/src/relay.ts` | Fixed async/await in memory dashboard handler |
| `/etc/systemd/system/ellie-dashboard.service` | Created new systemd service |

### System Status at End of Session

- Dashboard: running via systemd on `127.0.0.1:3000` (production mode)
- Relay: running on port 3001 (nohup, not yet a systemd service)
- Cloudflared: running, routing `dashboard.ellie-labs.dev` → localhost:3000
- All health checks passing
