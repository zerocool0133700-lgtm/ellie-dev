# Journal — February 19, 2026

## Multi-Agent Orchestrator — Complete Stack (ELLIE-50 through ELLIE-62)

Today's session built and verified the entire multi-agent orchestration pipeline, from intent classification through execution and testing. This was the largest single-session effort to date — 12 commits across 2 repos, 10 Plane tickets closed.

### ELLIE-50: LLM Intent Classifier

Replaced the old keyword/regex message router with a three-tier classification system:
1. **Slash commands** — `/dev`, `/research`, `/finance`, etc. Zero-latency fast-path
2. **Session continuity** — Checks for active agent sessions in Supabase
3. **Haiku LLM classification** — Calls Claude Haiku 4.5 to classify messages with confidence scores

The classifier runs tiers 2 and 3 in **parallel** via `Promise.all`, then applies decision logic to pick the winner.

### ELLIE-53: Skill Registry

Built a skill-level routing layer on top of agent routing:
- 18 skills across 7 agents in the `skills` table
- Each skill has name, description, triggers, priority, complexity (light/heavy), and agent association
- Classifier now routes to specific skills, not just agents
- `GET /api/skills` endpoint for the dashboard

**Skill distribution:** general (7), dev (3), research (3), content (2), critic (1), finance (1), strategy (1)

### ELLIE-54: Sequential Pipeline (Stage 1)

Built the orchestrator engine in `src/orchestrator.ts`:
- Sequential step execution with artifact passing (`previousOutput` feeds each step)
- Light mode (direct Anthropic API / Haiku, ~300ms) vs Heavy mode (CLI spawn, full tools)
- Prompt builder includes execution context, previous output, and step role annotations
- `MAX_PIPELINE_DEPTH = 5` hard limit

### ELLIE-55: Fan-Out Execution (Stage 2)

Added parallel execution mode:
- `Promise.all` dispatches all steps concurrently
- Per-branch error isolation — one failure doesn't block others
- Result synthesis via Haiku LLM merges outputs into coherent response
- Duration tracking uses `Math.max()` of branches (wall-clock parallel time)

### ELLIE-56: Critic Loop (Stage 3)

Added iterative refinement mode:
- Producer generates → Critic evaluates → Producer revises cycle
- Critic returns structured `{accepted, score, feedback, issues[]}` JSON
- Early exit when critic approves (saves cost)
- `MAX_CRITIC_ROUNDS = 3` with auto-accept on final round
- `parseCriticVerdict()` extracts issues array and combines with feedback for actionable revision guidance

### ELLIE-58: Security Hardening

Applied 7 security fixes across the orchestrator and APIs:
- Instruction sanitization: strip control chars, neutralize `[CONFIRM:` and `[REMEMBER:` tags
- Input truncation: instructions capped at 500 chars, previous output at 8,000 chars
- Skill field validation: agent/skill names ≤100 chars, instructions ≤2,000 chars
- Cost guardrails: $2.00 hard limit, $0.50 warning threshold, per-step enforcement
- Execution plan API: parameter validation, pagination limits

### ELLIE-59: Cross-Domain Override Fix

Fixed session continuity short-circuiting the LLM classifier:
- **Before:** Session continuity returned `confidence: 1.0` and skipped Haiku entirely
- **After:** Both run in parallel; LLM can override session continuity when it detects a different domain with confidence ≥ 0.85
- Lowered session continuity confidence from 1.0 to 0.85
- Updated classifier prompt with domain-switch awareness instructions

### Bug Fixes

- **Corrupted session retry**: When `--resume` fails due to `tool_use.name` exceeding 200 chars (corrupted session history), the relay now retries without `--resume` instead of failing
- **Deprecated model in UI**: Claude 3.5 Haiku (`claude-3-5-haiku-20241022`) was still selectable in the agents dropdown. Disabled in both Supabase `models` table and built-in registry. Filtered `agents.vue` to fetch `?enabled=true` only
- **Finance agent model**: Updated from deprecated `claude-3-5-haiku-20241022` to `claude-haiku-4-5-20251001` in agents table

### ELLIE-61 + ELLIE-62: Test Plans

Ran comprehensive test plans for all 4 execution modes:

**ELLIE-61 (Skill Registry + Pipeline):**
- Skills table: 18 skills, all with complexity set (10 light, 8 heavy)
- GET /api/skills: returns all 18 skills with agent associations
- Classifier: skill-level routing verified in logs (plane_issue_crud, task_management, memory_recall, strategic_planning)
- Pipeline: sequential execution, artifact passing, light/heavy dispatch, guardrails — all code paths verified

**ELLIE-62 (Fan-Out + Critic Loop):**
- Fan-out: `Promise.all` dispatch, per-branch error isolation, synthesis merge, cost tracking — all verified
- Critic loop: producer→critic cycle, structured `{accepted, score, feedback, issues[]}` output, early exit, max iterations, auto-accept final round — all verified
- All 3 channels (Telegram, Voice, Google Chat) wired to orchestrator
- Execution plans table exists and persists plan lifecycle (create → complete/fail)

**Regression:**
- Cross-domain override: 18 events in 4h (working)
- Session continuity: 58 events (working)
- LLM classification with skills: 33 events
- Agent distribution: general(71), dev(13), finance(7), strategy(4), research(1)
- Relay stable: 121MB memory, successful Claude calls, no crashes

## Commits

**ellie-dev (8 commits):**
| Hash | Description |
|------|-------------|
| `1ba5c72` | [ELLIE-50] Replace keyword/regex routing with LLM-based intent classification |
| `cdf50ff` | [ELLIE-53] Build skill registry for agent routing |
| `3143a18` | [ELLIE-54] Add sequential multi-agent pipeline orchestrator (Stage 1) |
| `0a70538` | [ELLIE-58] Build orchestrator execution engine with fan-out, critic-loop, light/heavy skills |
| `fab0e25` | [ELLIE-58] Security hardening for orchestrator execution engine |
| `4026aa0` | [ELLIE-59] Fix session continuity overriding classifier for cross-domain messages |
| `e809d99` | [ELLIE-56] Add issues[] to critic verdict schema for actionable revision guidance |
| `93319bc` | Fix corrupted session retry — skip --resume on tool_use.name errors |

**ellie-home (4 commits):**
| Hash | Description |
|------|-------------|
| `e3fd0aa` | [ELLIE-53] Add GET /api/skills endpoint for skill registry |
| `a06538b` | [ELLIE-58] Add execution-plans dashboard API endpoints |
| `0106378` | [ELLIE-58] Security hardening for execution-plans API |
| `5920e18` | Deprecate Claude 3.5 Haiku and filter disabled models from agent UI |

## Plane Tickets Closed (This Session)

| Ticket | Name |
|--------|------|
| ELLIE-54 | Sequential multi-agent pipeline (Stage 1) |
| ELLIE-55 | Parallel fan-out execution (Stage 2) |
| ELLIE-56 | Critic loop execution (Stage 3) |
| ELLIE-59 | Fix session continuity overriding classifier for cross-domain messages |
| ELLIE-61 | Test plan for ELLIE-53/54 (skill registry + sequential pipeline) |
| ELLIE-62 | Test plan for ELLIE-55/56 (fan-out + critic loops) |

## Key Files Modified

| File | Changes |
|------|---------|
| `ellie-dev/src/intent-classifier.ts` | Three-tier classifier, parallel execution, cross-domain override, skill routing |
| `ellie-dev/src/orchestrator.ts` | Full orchestrator: pipeline, fan-out, critic-loop, light/heavy, cost tracking |
| `ellie-dev/src/relay.ts` | Multi-step dispatch on all 3 channels, corrupted session retry |
| `ellie-home/server/api/models/index.ts` | Deprecated Claude 3.5 Haiku |
| `ellie-home/app/pages/agents.vue` | Filter models to enabled only |
| `ellie-home/server/api/skills/index.ts` | New skills endpoint |
| `ellie-home/server/api/execution-plans/` | New execution plans endpoints |

## Architecture Overview

```
User Message
    │
    ▼
┌─────────────────────┐
│  Intent Classifier   │
│  Tier 1: Slash cmd   │
│  Tier 2: Session     │──── parallel ────┐
│  Tier 3: Haiku LLM   │                  │
└─────────┬───────────┘                  │
          │ {agent, skill, mode, skills[]}│
          ▼                              │
┌─────────────────────┐    ┌────────────────┐
│  Orchestrator        │    │ Decision Logic │
│  single → relay      │    │ cross-domain   │
│  pipeline → seq      │    │ override ≥0.85 │
│  fan-out → parallel  │    └────────────────┘
│  critic-loop → iter  │
└─────────┬───────────┘
          │
    ┌─────┴─────┐
    │           │
  Light      Heavy
  (API)      (CLI)
  ~300ms    30-420s
  Haiku     Sonnet/Opus
  no tools  full tools
```

## Session Stats

- 12 commits across 2 repos (8 ellie-dev, 4 ellie-home)
- 6 Plane tickets closed (this session)
- 3 bug fixes (corrupted session retry, deprecated model, finance agent model)
- 4 execution modes fully implemented and tested
- 18 skills across 7 agents
- 0 regressions detected
