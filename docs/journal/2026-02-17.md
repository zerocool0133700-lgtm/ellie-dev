# Journal — February 17, 2026

## Google Chat Integration (ELLIE-22) — Completed

Fixed the Google Chat webhook integration that was partially working from yesterday.

**Issues found & fixed:**
- Webhook payload format was wrong — Google Chat Workspace Add-ons use a nested `chat.messagePayload` structure, not the legacy top-level `type/message/space` format
- Updated `parseGoogleChatEvent()` in `google-chat.ts` to handle both legacy and new formats via a union type
- Async API responses were sending as the user (Dave) instead of the bot — OAuth sends messages as the authenticated user
- Switched to synchronous webhook responses using the `hostAppDataAction.chatDataAction.createMessageAction.message` format, which correctly sends as the bot
- Updated space name in `.env` to `spaces/7zVPcSAAAAE`

**Result:** Google Chat is fully working as a second messaging channel alongside Telegram.

---

## Close Conversation Button (ELLIE-24) — Completed

Added manual conversation closing from the dashboard.

**Changes:**
- `relay.ts`: Added `POST /api/consolidate` endpoint that calls `triggerConsolidation()`
- `ellie-home`: Created `close-conversation.post.ts` API route proxying to relay
- Added "Close Conversation" button to both QuickActions component and Conversations page header
- Both buttons use a double-click confirmation pattern with 3-second timeout

---

## Consolidation Moved to Max Subscription

The Anthropic API ran out of credits, which silently broke conversation consolidation (summary extraction + memory extraction). Realized consolidation doesn't need low-latency — only voice calls do.

**Changes:**
- `consolidate-inline.ts`: Replaced Anthropic SDK with Claude CLI spawn (uses Max subscription, no API credits)
- `summarize-backfill.ts`: Same switch
- `consolidate-memory.ts` and `relay.ts`: Updated `consolidateNow()` call signature (removed `anthropicKey` param)
- Voice calls (`callClaudeVoice`) remain on direct Haiku API for sub-600ms latency

**Bug fix — data loss prevention:**
- Messages were being marked `summarized=true` *before* the API call, so failures lost data permanently
- Now: messages linked to conversation first (`conversation_id` set), but `summarized` only set to `true` after successful extraction
- On failure: rollback unlinks messages and deletes the conversation record so they can be retried

**Bug fix — CLI output parsing:**
- CLI sometimes returns preamble text before JSON
- Added fallback regex extraction: looks for `{"summary"..."memories"...}` pattern in response

**Backfill results:**

| Metric | Before | After |
|--------|--------|-------|
| Conversations with summaries | 33/49 | 65/65 |
| Memories extracted | 338 | 412 |
| Unprocessed messages | 163 | 0 |

---

## Token Health Monitor — New Feature

Built an hourly monitoring system for API token health, displayed on the dashboard.

**Relay (`ellie-dev`):**
- `GET /api/token-health` — makes a minimal 1-token Haiku API call
- Returns status: `ok`, `low_credits`, `invalid_key`, `not_configured`, or `error`
- Includes latency measurement

**Dashboard (`ellie-home`):**
- New `token_health` DB table storing check history
- `GET /api/token-health` — returns latest 10 checks
- `POST /api/actions/check-tokens` — triggers check, stores result, emits SSE event
- `TokenHealthCard` widget on Status page with colored status dot, latency, and manual "Check" button

**Systemd timer:**
- `token-health-check.timer` runs every hour on the hour
- Calls dashboard endpoint via curl
- Persistent flag ensures missed checks run on boot

---

## Dashboard Access Fixed

The dashboard at `https://ellie.ellie-labs.dev/` was returning 500 errors. The `tunnel-guard.ts` middleware was blocking all non-webhook requests from the Cloudflare tunnel. Replaced with a no-op to make the dashboard publicly accessible. Auth can be added later via Cloudflare Access if needed.

---

## AI Token Audit (ELLIE-25) — Completed

Tested all services referenced in `docs/reference/ai-tokens.md`:

| Service | Status |
|---------|--------|
| Anthropic | OK (was failing, credits added) |
| ElevenLabs | OK (3399/100005 credits) |
| Supabase | OK |
| Telegram | OK |
| Plane | OK |
| Google Chat OAuth | OK |
| Elasticsearch | OK |

---

## Plane Items Closed

- **ELLIE-22** (Google Chat Module Setup) → Done
- **ELLIE-24** (Close Conversation Button) → Done
- **ELLIE-25** (Token Audit) → Done
- **ELLIE-20** (Fix Claude Code Extension Notifications) → Cancelled (duplicate of ELLIE-17)

**Remaining open:** ELLIE-21 (Integrate Figma MCP) — needs OAuth re-auth and relay wiring.

---

## Commits

**ellie-dev:**
- `a7600fc` — [ELLIE-24] Add POST /api/consolidate endpoint for manual conversation close
- `fb7a492` — Switch consolidation from Anthropic API to CLI (Max subscription), add token health endpoint

**ellie-home:**
- `f69f1e7` — [ELLIE-24] Add Close Conversation button to dashboard
- `c653c1a` — Add Token Health monitoring widget with hourly checks
